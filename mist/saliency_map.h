// 
// Copyright (c) 2003-2011, MIST Project, Nagoya University
// All rights reserved.
// 
// Redistribution and use in source and binary forms, with or without modification,
// are permitted provided that the following conditions are met:
// 
// 1. Redistributions of source code must retain the above copyright notice,
// this list of conditions and the following disclaimer.
// 
// 2. Redistributions in binary form must reproduce the above copyright notice,
// this list of conditions and the following disclaimer in the documentation
// and/or other materials provided with the distribution.
// 
// 3. Neither the name of the Nagoya University nor the names of its contributors
// may be used to endorse or promote products derived from this software
// without specific prior written permission.
// 
// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR
// IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
// FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR
// CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
// DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
// DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER
// IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF
// THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
// 

/// @file mist/saliency_map.h
//!
//! @brief Saliency map関連のアルゴリズム
//! 

#ifndef __INCLUDE_MIST_SALIENCY_MAP__
#define __INCLUDE_MIST_SALIENCY_MAP__

#ifndef __INCLUDE_MIST_H__
#include "mist.h"
#endif

#ifndef __INCLUDE_MIST_COLOR_H__
#include <mist/config/color.h>
#endif

#ifndef __INCLUDE_MIST_INTERPOLATE__
#include <mist/interpolate.h>
#endif

#ifndef __INCLUDE_FILTER_LINEAR_FILTER_H__
#include <mist/filter/linear.h>
#endif


#include <algorithm>
#include <numeric>


// mist名前空間の始まり
_MIST_BEGIN


namespace __itti__
{
	/// IttiらのSaliency map関連のアルゴリズム
	//! - 参考文献
	//!   Laurent Itti, Christof Koch, and Ernst Niebur,
	//!   "A model of saliency-based visual attention for rapid scene analysis,"
	//!   IEEE Transactions on Pattern Analysis and Machine Intelligence, vol.20, no.11, Nov. 1998
	//!
	//! @attention MISTのarray2コンテナ同士の四則演算を有効にしてください

	// IttiのSaliency mapにおける定数（触るな危険）
	const size_t PYRAMID_SCALES = 9;					///< @brief ガウシアンピラミッドにおけるスケール数（SCALE_Cの0番目の要素より大きい値にしなければならない）
	const size_t SCALE_C[ ] = { 2, 3, 4 };				///< @brief Centerのスケール
	const size_t SCALE_D[ ] = { 3, 4 };					///< @brief Surroundのスケール
	const size_t TARGET_SCALE = 4;						///< @brief Across-scale additionにおけるCenterのベーススケール

	typedef double						value_type;		///< @brief Feature map および Conspicuity mapで使用するデータ型
	typedef mist::array2< value_type >	map_type;		///< @brief Feature map および Conspicuity mapの型
	typedef mist::array< map_type >		pyramid_type;	///< @brief Gaussianピラミッドの型
	typedef mist::array< map_type >		maps_type;		///< @brief Feature mapを管理するコンテナの型
	typedef mist::array2< value_type >	kernel_type;	///< @brief Gabor filterで利用するカーネルの型

	///< @brief Gabor filterで利用するカーネル
	const value_type GABOR_KERNELS[ ][ 17 ][ 17 ] = {	{	{ -0.000213458164049294360000,	-0.000216644186888885490000,	-0.000267420737091965140000,	-0.000216644186888885440000,	0.000150241317361511160000,		-0.000216644186888885630000,	-0.00141849613025914330000,		-0.000216644186888885380000,	0.00156829918464734320000,		-0.000216644186888885380000,	-0.00141849613025914330000,		-0.000216644186888885630000,	0.000150241317361511160000,		-0.000216644186888885440000,	-0.000267420737091965140000,	-0.000216644186888885490000,	-0.000213458164049294360000 },
															{ -0.000202603142700600670000,	-0.000216644186888885520000,	-0.000440420293033059370000,	-0.000216644186888885280000,	0.001400248044141730000,		-0.000216644186888886090000,	-0.00551329681440221750000,		-0.000216644186888885060000,	0.0076497365690452760000,		-0.000216644186888885060000,	-0.00551329681440221750000,		-0.000216644186888886090000,	0.001400248044141730000,		-0.000216644186888885280000,	-0.000440420293033059370000,	-0.000216644186888885520000,	-0.000202603142700600670000 },
															{ -0.000165867636685805850000,	-0.00021664418688888560000,		-0.00102588447810310350000,		-0.000216644186888884760000,	0.00563051421821007290000,		-0.000216644186888887630000,	-0.019370899699708920000,		-0.000216644186888883920000,	0.0282305049007476120000,		-0.000216644186888883920000,	-0.019370899699708920000,		-0.000216644186888887630000,	0.00563051421821007290000,		-0.000216644186888884760000,	-0.00102588447810310350000,		-0.00021664418688888560000,		-0.000165867636685805850000 },
															{ -6.59695199285921010000e-005,	-0.000216644186888885790000,	-0.0026179891164260210000,		-0.000216644186888883320000,	0.0171342518828273910000,		-0.000216644186888891860000,	-0.0570551071924256320000,		-0.00021664418688888080000,		0.0841976119531329390000,		-0.00021664418688888080000,		-0.0570551071924256320000,		-0.000216644186888891860000,	0.0171342518828273910000,		-0.000216644186888883320000,	-0.0026179891164260210000,		-0.000216644186888885790000,	-6.59695199285921010000e-005 },
															{ 0.000150241317361511160000,	-0.00021664418688888620000,		-0.00606380259198784420000,		-0.000216644186888880180000,	0.0420319459852840570000,		-0.0002166441868889010000,		-0.138615544156578060000,		-0.000216644186888874080000,	0.205327974259260050000,		-0.000216644186888874080000,	-0.138615544156578060000,		-0.0002166441868889010000,		0.0420319459852840570000,		-0.000216644186888880180000,	-0.00606380259198784420000,		-0.00021664418688888620000,		0.000150241317361511160000 },
															{ 0.000516406710280523270000,	-0.000216644186888886870000,	-0.0118994843784274890000,		-0.000216644186888874870000,	0.0841976119531329390000,		-0.000216644186888916470000,	-0.276742799117225710000,		-0.000216644186888862720000,	0.410469156191473670000,		-0.000216644186888862720000,	-0.276742799117225710000,		-0.000216644186888916470000,	0.0841976119531329390000,		-0.000216644186888874870000,	-0.0118994843784274890000,		-0.000216644186888886870000,	0.000516406710280523270000 },
															{ 0.000985207756481372430000,	-0.000216644186888887770000,	-0.019370899699708920000,		-0.000216644186888868090000,	0.13818225578280030000,			-0.000216644186888936290000,	-0.45358693263348410000,		-0.000216644186888848140000,	0.673111127738935560000,		-0.000216644186888848140000,	-0.45358693263348410000,		-0.000216644186888936290000,	0.13818225578280030000,			-0.000216644186888868090000,	-0.019370899699708920000,		-0.000216644186888887770000,	0.000985207756481372430000 },
															{ 0.001400248044141730000,		-0.000216644186888888560000,	-0.0259855145545702070000,		-0.000216644186888862070000,	0.185976095591570160000,		-0.000216644186888953820000,	-0.610151088452771220000,		-0.000216644186888835240000,	0.905634071759926610000,		-0.000216644186888835240000,	-0.610151088452771220000,		-0.000216644186888953820000,	0.185976095591570160000,		-0.000216644186888862070000,	-0.0259855145545702070000,		-0.000216644186888888560000,	0.001400248044141730000 },
															{ 0.00156829918464734320000,	-0.000216644186888888850000,	-0.0286637932745253820000,		-0.000216644186888859660000,	0.205327974259260050000,		-0.000216644186888960930000,	-0.673544416112713430000,		-0.000216644186888830040000,	0.999783355813111060000,		-0.000216644186888830040000,	-0.673544416112713430000,		-0.000216644186888960930000,	0.205327974259260050000,		-0.000216644186888859660000,	-0.0286637932745253820000,		-0.000216644186888888850000,	0.00156829918464734320000 },
															{ 0.001400248044141730000,		-0.000216644186888888560000,	-0.0259855145545702070000,		-0.000216644186888862070000,	0.185976095591570160000,		-0.000216644186888953820000,	-0.610151088452771220000,		-0.000216644186888835240000,	0.905634071759926610000,		-0.000216644186888835240000,	-0.610151088452771220000,		-0.000216644186888953820000,	0.185976095591570160000,		-0.000216644186888862070000,	-0.0259855145545702070000,		-0.000216644186888888560000,	0.001400248044141730000 },
															{ 0.000985207756481372430000,	-0.000216644186888887770000,	-0.019370899699708920000,		-0.000216644186888868090000,	0.13818225578280030000,			-0.000216644186888936290000,	-0.45358693263348410000,		-0.000216644186888848140000,	0.673111127738935560000,		-0.000216644186888848140000,	-0.45358693263348410000,		-0.000216644186888936290000,	0.13818225578280030000,			-0.000216644186888868090000,	-0.019370899699708920000,		-0.000216644186888887770000,	0.000985207756481372430000 },
															{ 0.000516406710280523270000,	-0.000216644186888886870000,	-0.0118994843784274890000,		-0.000216644186888874870000,	0.0841976119531329390000,		-0.000216644186888916470000,	-0.276742799117225710000,		-0.000216644186888862720000,	0.410469156191473670000,		-0.000216644186888862720000,	-0.276742799117225710000,		-0.000216644186888916470000,	0.0841976119531329390000,		-0.000216644186888874870000,	-0.0118994843784274890000,		-0.000216644186888886870000,	0.000516406710280523270000 },
															{ 0.000150241317361511160000,	-0.00021664418688888620000,		-0.00606380259198784420000,		-0.000216644186888880180000,	0.0420319459852840570000,		-0.0002166441868889010000,		-0.138615544156578060000,		-0.000216644186888874080000,	0.205327974259260050000,		-0.000216644186888874080000,	-0.138615544156578060000,		-0.0002166441868889010000,		0.0420319459852840570000,		-0.000216644186888880180000,	-0.00606380259198784420000,		-0.00021664418688888620000,		0.000150241317361511160000 },
															{ -6.59695199285921010000e-005,	-0.000216644186888885790000,	-0.0026179891164260210000,		-0.000216644186888883320000,	0.0171342518828273910000,		-0.000216644186888891860000,	-0.0570551071924256320000,		-0.00021664418688888080000,		0.0841976119531329390000,		-0.00021664418688888080000,		-0.0570551071924256320000,		-0.000216644186888891860000,	0.0171342518828273910000,		-0.000216644186888883320000,	-0.0026179891164260210000,		-0.000216644186888885790000,	-6.59695199285921010000e-005 },
															{ -0.000165867636685805850000,	-0.00021664418688888560000,		-0.00102588447810310350000,		-0.000216644186888884760000,	0.00563051421821007290000,		-0.000216644186888887630000,	-0.019370899699708920000,		-0.000216644186888883920000,	0.0282305049007476120000,		-0.000216644186888883920000,	-0.019370899699708920000,		-0.000216644186888887630000,	0.00563051421821007290000,		-0.000216644186888884760000,	-0.00102588447810310350000,		-0.00021664418688888560000,		-0.000165867636685805850000 },
															{ -0.000202603142700600670000,	-0.000216644186888885520000,	-0.000440420293033059370000,	-0.000216644186888885280000,	0.001400248044141730000,		-0.000216644186888886090000,	-0.00551329681440221750000,		-0.000216644186888885060000,	0.0076497365690452760000,		-0.000216644186888885060000,	-0.00551329681440221750000,		-0.000216644186888886090000,	0.001400248044141730000,		-0.000216644186888885280000,	-0.000440420293033059370000,	-0.000216644186888885520000,	-0.000202603142700600670000 },
															{ -0.000213458164049294360000,	-0.000216644186888885490000,	-0.000267420737091965140000,	-0.000216644186888885440000,	0.000150241317361511160000,		-0.000216644186888885630000,	-0.00141849613025914330000,		-0.000216644186888885380000,	0.00156829918464734320000,		-0.000216644186888885380000,	-0.00141849613025914330000,		-0.000216644186888885630000,	0.000150241317361511160000,		-0.000216644186888885440000,	-0.000267420737091965140000,	-0.000216644186888885490000,	-0.000213458164049294360000 } },
														{	{ -0.000214134630995543680000,	-0.000223776723112709650000,	-0.000265786932032037330000,	-0.000260486197811391280000,	4.97134655875106870000e-005,	0.000473356818591131160000,		-8.17539241526291530000e-005,	-0.00157541215951787070000,		-0.00174750913491093460000,		-8.81425456724273390000e-005,	0.000899967028943327880000,		0.000330813391145330870000,		-0.000313327068380500440000,	-0.000363588772779722020000,	-0.000246397192664999550000,	-0.00020940739692195480000,		-0.000212455820116682450000 },
															{ -0.000223776723112709650000,	-0.000276752245330171990000,	-0.000282242920061493450000,	0.000264630954308320160000,		0.00130408425975803420000,		0.000144252542662046390000,		-0.00467000861014636990000,		-0.00633109010842272490000,		0.000404658013336243150000,		0.00639879059704404240000,		0.00373276550870103390000,		-0.00107580924696983940000,		-0.00180326268368728290000,		-0.000617847560383964750000,	-0.000116281707141739880000,	-0.000153761896758942150000,	-0.000209407396921954830000 },
															{ -0.000265786932032037330000,	-0.000282242920061493450000,	0.000369653036981674190000,		0.00204139576350936950000,		0.000435739447470087230000,		-0.0100406499670049570000,		-0.0166541339484946040000,		0.00181635064276655070000,		0.0261901829988486910000,		0.0189938484443885790000,		-0.00531556469607083990000,		-0.0116869818686263660000,		-0.00375726491171347180000,		0.000850593343845249870000,		0.000593598448257943650000,		-0.000116281707141740460000,	-0.000246397192664999660000 },
															{ -0.000260486197811391280000,	0.000264630954308320160000,		0.00204139576350936650000,		0.00057817812008419990000,		-0.0148073585873103630000,		-0.0299680542957719880000,		0.00426632915846320620000,		0.0707639371444771930000,		0.0627112466972920560000,		-0.020575313029809510000,		-0.0560251303734258590000,		-0.0212138851397783850000,		0.0074884308558516030000,		0.00691012479671693210000,		0.000850593343845247050000,		-0.000617847560383965940000,	-0.000363588772779721920000 },
															{ 4.97134655875090610000e-005,	0.00130408425975803520000,		0.000435739447470087230000,		-0.0148073585873103630000,		-0.036474065750403670000,		0.00644080571244505780000,		0.128251963105421830000,		0.138582356490498270000,		-0.0549429945321079360000,		-0.183037643453210440000,		-0.0840438371584509430000,		0.0372656250325677850000,		0.042032948329216710000,		0.00748843085585157960000,		-0.00375726491171348220000,		-0.00180326268368728250000,		-0.000313327068380500060000 },
															{ 0.000473356818591131590000,	0.000144252542662051760000,		-0.0100406499670049570000,		-0.0299680542957719880000,		0.00644080571244505780000,		0.156344196320753580000,		0.205921701841042190000,		-0.0992679611922332730000,		-0.403466596458147640000,		-0.225548122324692350000,		0.122566351210613960000,		0.168447184789459910000,		0.0372656250325676670000,		-0.0212138851397784230000,		-0.0116869818686263630000,		-0.00107580924696983480000,		0.000330813391145331730000 },
															{ -8.17539241526270390000e-005,	-0.00467000861014636990000,		-0.0166541339484945930000,		0.0042663291584632080000,		0.128251963105421670000,		0.205921701841042190000,		-0.120927903064719770000,		-0.599108144764422870000,		-0.408050183798901730000,		0.270604912971661450000,		0.453154646603639020000,		0.122566351210613680000,		-0.0840438371584510820000,		-0.0560251303734258170000,		-0.0053155646960708260000,		0.00373276550870103650000,		0.000899967028943327010000 },
															{ -0.00157541215951787070000,	-0.00633109010842273020000,		0.00181635064276650390000,		0.0707639371444771380000,		0.138582356490498380000,		-0.0992679611922332730000,		-0.599108144764422650000,		-0.497232067982842470000,		0.401996425008270990000,		0.820349877738402070000,		0.270604912971661280000,		-0.225548122324692460000,		-0.183037643453210440000,		-0.020575313029809510000,		0.0189938484443886170000,		0.00639879059704402940000,		-8.81425456724330850000e-005 },
															{ -0.00174750913491093460000,	0.000404658013336229270000,		0.0261901829988486730000,		0.0627112466972920970000,		-0.0549429945321079360000,		-0.403466596458147590000,		-0.408050183798901730000,		0.401996425008270990000,		0.99978435815704370000,			0.401996425008270990000,		-0.408050183798901730000,		-0.403466596458147590000,		-0.0549429945321079360000,		0.0627112466972920970000,		0.0261901829988486730000,		0.000404658013336229270000,		-0.00174750913491093460000 },
															{ -8.81425456724330850000e-005,	0.00639879059704402940000,		0.0189938484443886170000,		-0.020575313029809510000,		-0.183037643453210440000,		-0.225548122324692460000,		0.270604912971661280000,		0.820349877738402070000,		0.401996425008270990000,		-0.497232067982842470000,		-0.599108144764422650000,		-0.0992679611922332730000,		0.138582356490498380000,		0.0707639371444771380000,		0.00181635064276650390000,		-0.00633109010842273020000,		-0.00157541215951787070000 },
															{ 0.000899967028943327010000,	0.00373276550870103650000,		-0.0053155646960708260000,		-0.0560251303734258170000,		-0.0840438371584510820000,		0.122566351210613680000,		0.453154646603639020000,		0.270604912971661450000,		-0.408050183798901730000,		-0.599108144764422870000,		-0.120927903064719770000,		0.205921701841042190000,		0.128251963105421670000,		0.0042663291584632080000,		-0.0166541339484945930000,		-0.00467000861014636990000,		-8.17539241526270390000e-005 },
															{ 0.000330813391145331730000,	-0.00107580924696983480000,		-0.0116869818686263630000,		-0.0212138851397784230000,		0.0372656250325676670000,		0.168447184789459910000,		0.122566351210613960000,		-0.225548122324692350000,		-0.403466596458147640000,		-0.0992679611922332730000,		0.205921701841042190000,		0.156344196320753580000,		0.00644080571244505780000,		-0.0299680542957719880000,		-0.0100406499670049570000,		0.000144252542662051760000,		0.000473356818591131590000 },
															{ -0.000313327068380500060000,	-0.00180326268368728250000,		-0.00375726491171348220000,		0.00748843085585157960000,		0.042032948329216710000,		0.0372656250325677850000,		-0.0840438371584509430000,		-0.183037643453210440000,		-0.0549429945321079360000,		0.138582356490498270000,		0.128251963105421830000,		0.00644080571244505780000,		-0.036474065750403670000,		-0.0148073585873103630000,		0.000435739447470087230000,		0.00130408425975803520000,		4.97134655875090610000e-005 },
															{ -0.000363588772779721920000,	-0.000617847560383965940000,	0.000850593343845247050000,		0.00691012479671693210000,		0.0074884308558516030000,		-0.0212138851397783850000,		-0.0560251303734258590000,		-0.020575313029809510000,		0.0627112466972920560000,		0.0707639371444771930000,		0.00426632915846320620000,		-0.0299680542957719880000,		-0.0148073585873103630000,		0.00057817812008419990000,		0.00204139576350936650000,		0.000264630954308320160000,		-0.000260486197811391280000 },
															{ -0.000246397192664999660000,	-0.000116281707141740460000,	0.000593598448257943650000,		0.000850593343845249870000,		-0.00375726491171347180000,		-0.0116869818686263660000,		-0.00531556469607083990000,		0.0189938484443885790000,		0.0261901829988486910000,		0.00181635064276655070000,		-0.0166541339484946040000,		-0.0100406499670049570000,		0.000435739447470087230000,		0.00204139576350936950000,		0.000369653036981674190000,		-0.000282242920061493450000,	-0.000265786932032037330000 },
															{ -0.000209407396921954830000,	-0.000153761896758942150000,	-0.000116281707141739880000,	-0.000617847560383964750000,	-0.00180326268368728290000,		-0.00107580924696983940000,		0.00373276550870103390000,		0.00639879059704404240000,		0.000404658013336243150000,		-0.00633109010842272490000,		-0.00467000861014636990000,		0.000144252542662046390000,		0.00130408425975803420000,		0.000264630954308320160000,		-0.000282242920061493450000,	-0.000276752245330171990000,	-0.000223776723112709650000 },
															{ -0.000212455820116682450000,	-0.00020940739692195480000,		-0.000246397192664999550000,	-0.000363588772779722020000,	-0.000313327068380500440000,	0.000330813391145330870000,		0.000899967028943327880000,		-8.81425456724273390000e-005,	-0.00174750913491093460000,		-0.00157541215951787070000,		-8.17539241526291530000e-005,	0.000473356818591131160000,		4.97134655875106870000e-005,	-0.000260486197811391280000,	-0.000265786932032037330000,	-0.000223776723112709650000,	-0.000214134630995543680000 } },
														{	{ -0.000213458164049299130000,	-0.000202603142700605410000,	-0.000165867636685810620000,	-6.59695199285968710000e-005,	0.000150241317361506390000,		0.00051640671028051850000,		0.000985207756481367660000,		0.00140024804414172520000,		0.00156829918464733840000,		0.00140024804414172520000,		0.000985207756481367660000,		0.00051640671028051850000,		0.000150241317361506390000,		-6.59695199285971420000e-005,	-0.00016586763668581070000,		-0.000202603142700605470000,	-0.000213458164049299130000 },
															{ -0.000216644186888890240000,	-0.000216644186888890290000,	-0.000216644186888890370000,	-0.000216644186888890560000,	-0.000216644186888890970000,	-0.000216644186888891650000,	-0.000216644186888892540000,	-0.000216644186888893330000,	-0.000216644186888893620000,	-0.000216644186888893330000,	-0.000216644186888892540000,	-0.000216644186888891650000,	-0.000216644186888890970000,	-0.000216644186888890560000,	-0.000216644186888890370000,	-0.000216644186888890290000,	-0.000216644186888890290000 },
															{ -0.000267420737091969860000,	-0.000440420293033064140000,	-0.00102588447810310820000,		-0.00261798911642602580000,		-0.00606380259198784860000,		-0.0118994843784274940000,		-0.0193708996997089270000,		-0.0259855145545702140000,		-0.0286637932745253880000,		-0.0259855145545702140000,		-0.0193708996997089270000,		-0.0118994843784274940000,		-0.00606380259198784860000,		-0.00261798911642602580000,		-0.00102588447810310820000,		-0.000440420293033064140000,	-0.000267420737091969910000 },
															{ -0.000216644186888890480000,	-0.000216644186888890050000,	-0.000216644186888889530000,	-0.000216644186888888090000,	-0.000216644186888884950000,	-0.000216644186888879640000,	-0.000216644186888872860000,	-0.000216644186888866840000,	-0.000216644186888864430000,	-0.000216644186888866840000,	-0.000216644186888872860000,	-0.000216644186888879640000,	-0.000216644186888884950000,	-0.000216644186888888090000,	-0.000216644186888889530000,	-0.000216644186888890050000,	-0.000216644186888889940000 },
															{ 0.000150241317361506390000,	0.00140024804414172520000,		0.00563051421821006860000,		0.0171342518828273840000,		0.0420319459852840780000,		0.0841976119531329250000,		0.13818225578280030000,			0.185976095591570160000,		0.205327974259260050000,		0.185976095591570160000,		0.13818225578280030000,			0.0841976119531328840000,		0.0420319459852840780000,		0.0171342518828273840000,		0.00563051421821006860000,		0.00140024804414172520000,		0.000150241317361506390000 },
															{ -0.000216644186888889750000,	-0.000216644186888887990000,	-0.000216644186888882020000,	-0.000216644186888865840000,	-0.000216644186888830790000,	-0.000216644186888921240000,	-0.000216644186888941060000,	-0.000216644186888958590000,	-0.00021664418688896570000,		-0.000216644186888958590000,	-0.000216644186888941060000,	-0.000216644186888921240000,	-0.000216644186888980740000,	-0.000216644186888927420000,	-0.000216644186888902790000,	-0.000216644186888893730000,	-0.000216644186888891050000 },
															{ -0.00141849613025914810000,	-0.00551329681440222190000,		-0.0193708996997089270000,		-0.0570551071924256320000,		-0.138615544156578060000,		-0.276742799117225710000,		-0.453586932633484150000,		-0.610151088452771220000,		-0.673544416112713430000,		-0.610151088452771220000,		-0.453586932633484150000,		-0.276742799117225710000,		-0.138615544156578060000,		-0.0570551071924256320000,		-0.0193708996997089270000,		-0.00551329681440222190000,		-0.00141849613025914810000 },
															{ -0.000216644186888891240000,	-0.000216644186888894570000,	-0.000216644186888905850000,	-0.000216644186888919540000,	-0.000216644186888961550000,	-0.00021664418688903270000,		-0.000216644186889123770000,	-0.000216644186888840010000,	-0.000216644186888834810000,	-0.000216644186888657810000,	-0.00021664418688871750000,		-0.000216644186888702260000,	-0.000216644186888796180000,	-0.000216644186888851610000,	-0.000216644186888877250000,	-0.000216644186888885090000,	-0.00021664418688888910000 },
															{ 0.00156829918464733840000,	0.00764973656904527170000,		0.0282305049007476050000,		0.0841976119531329250000,		0.205327974259260050000,		0.410469156191473670000,		0.673111127738935560000,		0.905634071759926610000,		0.999783355813111060000,		0.905634071759926610000,		0.673111127738935560000,		0.410469156191473670000,		0.205327974259260050000,		0.0841976119531329250000,		0.0282305049007476050000,		0.00764973656904527170000,		0.00156829918464733840000 },
															{ -0.00021664418688888910000,	-0.000216644186888885090000,	-0.000216644186888877250000,	-0.000216644186888851610000,	-0.000216644186888796180000,	-0.000216644186888702260000,	-0.00021664418688871750000,		-0.000216644186888657810000,	-0.000216644186888834810000,	-0.000216644186888840010000,	-0.000216644186889123770000,	-0.00021664418688903270000,		-0.000216644186888961550000,	-0.000216644186888919540000,	-0.000216644186888905850000,	-0.000216644186888894570000,	-0.000216644186888891240000 },
															{ -0.00141849613025914810000,	-0.00551329681440222190000,		-0.0193708996997089270000,		-0.0570551071924256320000,		-0.138615544156578060000,		-0.276742799117225710000,		-0.453586932633484150000,		-0.610151088452771220000,		-0.673544416112713430000,		-0.610151088452771220000,		-0.453586932633484150000,		-0.276742799117225710000,		-0.138615544156578060000,		-0.0570551071924256320000,		-0.0193708996997089270000,		-0.00551329681440222190000,		-0.00141849613025914810000 },
															{ -0.000216644186888891050000,	-0.000216644186888893730000,	-0.000216644186888902790000,	-0.000216644186888927420000,	-0.000216644186888980740000,	-0.000216644186888921240000,	-0.000216644186888941060000,	-0.000216644186888958590000,	-0.00021664418688896570000,		-0.000216644186888958590000,	-0.000216644186888941060000,	-0.000216644186888921240000,	-0.000216644186888830790000,	-0.000216644186888865840000,	-0.000216644186888882020000,	-0.000216644186888887990000,	-0.000216644186888889750000 },
															{ 0.000150241317361506390000,	0.00140024804414172520000,		0.00563051421821006860000,		0.0171342518828273840000,		0.0420319459852840780000,		0.0841976119531328840000,		0.13818225578280030000,			0.185976095591570160000,		0.205327974259260050000,		0.185976095591570160000,		0.13818225578280030000,			0.0841976119531329250000,		0.0420319459852840780000,		0.0171342518828273840000,		0.00563051421821006860000,		0.00140024804414172520000,		0.000150241317361506390000 },
															{ -0.000216644186888889940000,	-0.000216644186888890050000,	-0.000216644186888889530000,	-0.000216644186888888090000,	-0.000216644186888884950000,	-0.000216644186888879640000,	-0.000216644186888872860000,	-0.000216644186888866840000,	-0.000216644186888864430000,	-0.000216644186888866840000,	-0.000216644186888872860000,	-0.000216644186888879640000,	-0.000216644186888884950000,	-0.000216644186888888090000,	-0.000216644186888889530000,	-0.000216644186888890050000,	-0.000216644186888890480000 },
															{ -0.000267420737091969910000,	-0.000440420293033064140000,	-0.00102588447810310820000,		-0.00261798911642602580000,		-0.00606380259198784860000,		-0.0118994843784274940000,		-0.0193708996997089270000,		-0.0259855145545702140000,		-0.0286637932745253880000,		-0.0259855145545702140000,		-0.0193708996997089270000,		-0.0118994843784274940000,		-0.00606380259198784860000,		-0.00261798911642602580000,		-0.00102588447810310820000,		-0.000440420293033064140000,	-0.000267420737091969860000 },
															{ -0.000216644186888890290000,	-0.000216644186888890290000,	-0.000216644186888890370000,	-0.000216644186888890560000,	-0.000216644186888890970000,	-0.000216644186888891650000,	-0.000216644186888892540000,	-0.000216644186888893330000,	-0.000216644186888893620000,	-0.000216644186888893330000,	-0.000216644186888892540000,	-0.000216644186888891650000,	-0.000216644186888890970000,	-0.000216644186888890560000,	-0.000216644186888890370000,	-0.000216644186888890290000,	-0.000216644186888890240000 },
															{ -0.000213458164049299130000,	-0.000202603142700605470000,	-0.00016586763668581070000,		-6.59695199285971420000e-005,	0.000150241317361506390000,		0.00051640671028051850000,		0.000985207756481367660000,		0.00140024804414172520000,		0.00156829918464733840000,		0.00140024804414172520000,		0.000985207756481367660000,		0.00051640671028051850000,		0.000150241317361506390000,		-6.59695199285968710000e-005,	-0.000165867636685810620000,	-0.000202603142700605410000,	-0.000213458164049299130000 } },
														{	{ -0.000212455820116683020000,	-0.00020940739692195540000,		-0.000246397192665000250000,	-0.000363588772779722510000,	-0.000313327068380500610000,	0.000330813391145331190000,		0.000899967028943326470000,		-8.81425456724336540000e-005,	-0.00174750913491093520000,		-0.00157541215951787130000,		-8.17539241526276080000e-005,	0.000473356818591131050000,		4.97134655875084920000e-005,	-0.000260486197811391870000,	-0.000265786932032037870000,	-0.000223776723112710220000,	-0.000214134630995544250000 },
															{ -0.000209407396921955370000,	-0.000153761896758942750000,	-0.000116281707141741030000,	-0.000617847560383966480000,	-0.00180326268368728310000,		-0.00107580924696983530000,		0.0037327655087010360000,		0.00639879059704402850000,		0.000404658013336228730000,		-0.0063310901084227310000,		-0.00467000861014637070000,		0.000144252542662051190000,		0.00130408425975803460000,		0.000264630954308319620000,		-0.000282242920061493990000,	-0.000276752245330172530000,	-0.000223776723112710220000 },
															{ -0.000246397192665000140000,	-0.000116281707141740450000,	0.000593598448257943110000,		0.000850593343845246510000,		-0.00375726491171348270000,		-0.0116869818686263640000,		-0.00531556469607082690000,		0.0189938484443886170000,		0.0261901829988486730000,		0.00181635064276650320000,		-0.0166541339484945930000,		-0.0100406499670049570000,		0.000435739447470086680000,		0.00204139576350936610000,		0.000369653036981673640000,		-0.000282242920061493990000,	-0.000265786932032037870000 },
															{ -0.000363588772779722570000,	-0.000617847560383965290000,	0.000850593343845249330000,		0.00691012479671693130000,		0.00748843085585157880000,		-0.0212138851397784230000,		-0.0560251303734258170000,		-0.020575313029809510000,		0.0627112466972920970000,		0.0707639371444771380000,		0.00426632915846320710000,		-0.0299680542957719880000,		-0.0148073585873103630000,		0.000578178120084199360000,		0.00204139576350936910000,		0.000264630954308319620000,		-0.000260486197811391870000 },
															{ -0.000313327068380500990000,	-0.00180326268368728360000,		-0.00375726491171347230000,		0.00748843085585160220000,		0.042032948329216710000,		0.0372656250325676670000,		-0.0840438371584510820000,		-0.183037643453210440000,		-0.0549429945321079360000,		0.138582356490498380000,		0.128251963105421670000,		0.00644080571244505690000,		-0.036474065750403670000,		-0.0148073585873103630000,		0.000435739447470086680000,		0.00130408425975803350000,		4.97134655875101180000e-005 },
															{ 0.000330813391145330320000,	-0.001075809246969840000,		-0.0116869818686263680000,		-0.0212138851397783850000,		0.0372656250325677850000,		0.168447184789459910000,		0.122566351210613680000,		-0.225548122324692460000,		-0.403466596458147590000,		-0.0992679611922332730000,		0.205921701841042190000,		0.156344196320753580000,		0.00644080571244505690000,		-0.0299680542957719880000,		-0.0100406499670049570000,		0.000144252542662045820000,		0.000473356818591130620000 },
															{ 0.000899967028943327330000,	0.00373276550870103340000,		-0.00531556469607084080000,		-0.0560251303734258590000,		-0.0840438371584509430000,		0.122566351210613960000,		0.453154646603639020000,		0.270604912971661280000,		-0.408050183798901730000,		-0.599108144764422650000,		-0.120927903064719770000,		0.205921701841042190000,		0.128251963105421830000,		0.00426632915846320540000,		-0.0166541339484946040000,		-0.00467000861014637070000,		-8.17539241526297220000e-005 },
															{ -8.81425456724279080000e-005,	0.00639879059704404150000,		0.0189938484443885790000,		-0.020575313029809510000,		-0.183037643453210440000,		-0.225548122324692350000,		0.270604912971661450000,		0.820349877738402070000,		0.401996425008270990000,		-0.497232067982842470000,		-0.599108144764422870000,		-0.0992679611922332730000,		0.138582356490498270000,		0.0707639371444771930000,		0.00181635064276655010000,		-0.00633109010842272580000,		-0.00157541215951787130000 },
															{ -0.00174750913491093520000,	0.000404658013336242610000,		0.0261901829988486910000,		0.0627112466972920560000,		-0.0549429945321079360000,		-0.403466596458147640000,		-0.408050183798901730000,		0.401996425008270990000,		0.99978435815704370000,			0.401996425008270990000,		-0.408050183798901730000,		-0.403466596458147640000,		-0.0549429945321079360000,		0.0627112466972920560000,		0.0261901829988486910000,		0.000404658013336242610000,		-0.00174750913491093520000 },
															{ -0.00157541215951787130000,	-0.00633109010842272580000,		0.00181635064276655010000,		0.0707639371444771930000,		0.138582356490498270000,		-0.0992679611922332730000,		-0.599108144764422870000,		-0.497232067982842470000,		0.401996425008270990000,		0.820349877738402070000,		0.270604912971661450000,		-0.225548122324692350000,		-0.183037643453210440000,		-0.020575313029809510000,		0.0189938484443885790000,		0.00639879059704404150000,		-8.81425456724279080000e-005 },
															{ -8.17539241526297220000e-005,	-0.00467000861014637070000,		-0.0166541339484946040000,		0.00426632915846320540000,		0.128251963105421830000,		0.205921701841042190000,		-0.120927903064719770000,		-0.599108144764422650000,		-0.408050183798901730000,		0.270604912971661280000,		0.453154646603639020000,		0.122566351210613960000,		-0.0840438371584509430000,		-0.0560251303734258590000,		-0.00531556469607084080000,		0.00373276550870103340000,		0.000899967028943327330000 },
															{ 0.000473356818591130620000,	0.000144252542662045820000,		-0.0100406499670049570000,		-0.0299680542957719880000,		0.00644080571244505690000,		0.156344196320753580000,		0.205921701841042190000,		-0.0992679611922332730000,		-0.403466596458147590000,		-0.225548122324692460000,		0.122566351210613680000,		0.168447184789459910000,		0.0372656250325677850000,		-0.0212138851397783850000,		-0.0116869818686263680000,		-0.001075809246969840000,		0.000330813391145330320000 },
															{ 4.97134655875101180000e-005,	0.00130408425975803350000,		0.000435739447470086680000,		-0.0148073585873103630000,		-0.036474065750403670000,		0.00644080571244505690000,		0.128251963105421670000,		0.138582356490498380000,		-0.0549429945321079360000,		-0.183037643453210440000,		-0.0840438371584510820000,		0.0372656250325676670000,		0.042032948329216710000,		0.00748843085585160220000,		-0.00375726491171347230000,		-0.00180326268368728360000,		-0.000313327068380500990000 },
															{ -0.000260486197811391870000,	0.000264630954308319620000,		0.00204139576350936910000,		0.000578178120084199360000,		-0.0148073585873103630000,		-0.0299680542957719880000,		0.00426632915846320710000,		0.0707639371444771380000,		0.0627112466972920970000,		-0.020575313029809510000,		-0.0560251303734258170000,		-0.0212138851397784230000,		0.00748843085585157880000,		0.00691012479671693130000,		0.000850593343845249330000,		-0.000617847560383965290000,	-0.000363588772779722570000 },
															{ -0.000265786932032037870000,	-0.000282242920061493990000,	0.000369653036981673640000,		0.00204139576350936610000,		0.000435739447470086680000,		-0.0100406499670049570000,		-0.0166541339484945930000,		0.00181635064276650320000,		0.0261901829988486730000,		0.0189938484443886170000,		-0.00531556469607082690000,		-0.0116869818686263640000,		-0.00375726491171348270000,		0.000850593343845246510000,		0.000593598448257943110000,		-0.000116281707141740450000,	-0.000246397192665000140000 },
															{ -0.000223776723112710220000,	-0.000276752245330172530000,	-0.000282242920061493990000,	0.000264630954308319620000,		0.00130408425975803460000,		0.000144252542662051190000,		-0.00467000861014637070000,		-0.0063310901084227310000,		0.000404658013336228730000,		0.00639879059704402850000,		0.0037327655087010360000,		-0.00107580924696983530000,		-0.00180326268368728310000,		-0.000617847560383966480000,	-0.000116281707141741030000,	-0.000153761896758942750000,	-0.000209407396921955370000 },
															{ -0.000214134630995544250000,	-0.000223776723112710220000,	-0.000265786932032037870000,	-0.000260486197811391870000,	4.97134655875084920000e-005,	0.000473356818591131050000,		-8.17539241526276080000e-005,	-0.00157541215951787130000,		-0.00174750913491093520000,		-8.81425456724336540000e-005,	0.000899967028943326470000,		0.000330813391145331190000,		-0.000313327068380500610000,	-0.000363588772779722510000,	-0.000246397192665000250000,	-0.00020940739692195540000,		-0.000212455820116683020000 } } };

	// ガウシアンピラミッドを作成
	inline bool build_gaussian_pyramid( const map_type& in, const double gauss_sigma, pyramid_type& out_pyr )
	{
		out_pyr.resize( PYRAMID_SCALES );

		if( out_pyr.empty( ) )
		{
			return false;
		}

		out_pyr[ 0 ] = in;
		for( pyramid_type::size_type l = 1; l < out_pyr.size( ); ++l )
		{
			map_type temp;
			const pyramid_type::value_type::size_type w = out_pyr[ l - 1 ].width( ) / 2 + ( out_pyr[ l - 1 ].width( ) % 2 );
			const pyramid_type::value_type::size_type h = out_pyr[ l - 1 ].height( ) / 2 + ( out_pyr[ l - 1 ].height( ) % 2 );
			if( !mist::gaussian_filter( out_pyr[ l - 1 ], temp, gauss_sigma )
				|| !mist::nearest::interpolate( temp, out_pyr[ l ], w, h ) )
			{
				return false;
			}
		}

		return true;
	}

	// Center-Surround difference
	inline bool across_scale_difference( const pyramid_type& in1_pyr, const pyramid_type& in2_pyr, maps_type& out_fms )
	{
		const size_t center_scales = sizeof( SCALE_C ) / sizeof( SCALE_C[ 0 ] );	// Centerのスケールのレベル数
		const size_t delta_scales = sizeof( SCALE_D ) / sizeof( SCALE_D[ 0 ] );		// Surroundのスケールのレベル数

		out_fms.resize( center_scales * delta_scales );
		if( out_fms.empty( ) )
		{
			return false;
		}

		size_t level = 0;
		for( size_t c_index = 0; c_index < center_scales; ++c_index )
		{
			for( size_t d_index = 0; d_index < delta_scales; ++d_index )
			{
				const size_t c = SCALE_C[ c_index ];
				const size_t d = SCALE_D[ d_index ];
				const size_t s = c + d;
				const map_type& center = in1_pyr[ c ];
				const map_type& surround = in2_pyr[ s ];

				// スケール間差分
				map_type ex_surround;
				mist::linear::interpolate( surround, ex_surround, center.width( ), center.height( ) );
				out_fms[ level ].resize( ex_surround.width( ), ex_surround.height( ) );
				for( size_t i = 0; i < center.size( ); ++i )
				{
					out_fms[ level ][ i ] = std::fabs( center[ i ] - ex_surround[ i ] );
				}
				++level;
			}
		}
		
		return true;
	}

	// Center-Surround addition
	inline bool across_scale_addition( const maps_type& in_fms, map_type& out_fm )
	{
		if( in_fms.size( ) <= TARGET_SCALE )
		{
			return false;
		}

		// 各Feature mapをTARGET_SCALEに縮小
		const maps_type::value_type::size_type width = in_fms[ TARGET_SCALE ].width( );
		const maps_type::value_type::size_type height = in_fms[ TARGET_SCALE ].height( );

		maps_type target_scale_in_fms( in_fms.size( ) );
		for( maps_type::size_type l = 0; l < target_scale_in_fms.size( ); ++l )
		{
			mist::linear::interpolate( in_fms[ l ], target_scale_in_fms[ l ], width, height );
		}

		// スケール間加算
		out_fm = std::accumulate( target_scale_in_fms.begin( ), target_scale_in_fms.end( ), map_type( width, height ) );

		return true;
	}

	// 画像の画素値に関する正規化
	inline bool normalize( const map_type& in, map_type& out, const value_type min = 0.0, const value_type max = 1.0 )
	{
		if( in.empty( ) || min > max )
		{
			return false;
		}

		const auto minmax_value = std::minmax_element( in.begin( ), in.end( ) );
		out = ( ( in - *minmax_value.first ) / ( *minmax_value.second - *minmax_value.first ) ) * ( max - min ) + min;

		return true;
	}

	// 最大値・極大値を考慮した正規化（関数N）
	inline bool normalize_map_with_local_maxima( const map_type& in, const size_t step_local_maxima, map_type& out )
	{
		const value_type global_max = 1.0;
		if( !normalize( in, out, 0.0, global_max ) )
		{
			return false;
		}

		size_t local_maxima_count = 0;
		value_type local_maxima_sum = 0;

		// ±step_local_maximaの範囲の最大値を極大値とする
		for( map_type::size_type x = 0; x < out.width( ) - step_local_maxima; x += step_local_maxima )
		{
			for( map_type::size_type y = 0; y < out.height( ) - step_local_maxima; y += step_local_maxima )
			{
				map_type out_sub;
				out.trim( out_sub, x, y, step_local_maxima, step_local_maxima );
				const value_type local_max = *std::max_element( out_sub.begin( ), out_sub.end( ) );
				if( global_max != local_max )
				{
					local_maxima_sum += local_max;
					++local_maxima_count;
				}
			}
		}

		const value_type local_maxima_mean = local_maxima_sum / local_maxima_count;
		out *= std::pow( global_max - local_maxima_mean, 2.0 );

		return true;
	}

	// 最大値・極大値を考慮した正規化（関数N）
	inline bool normalize_maps_with_local_maxima( const maps_type& in_fms, const size_t step_local_maxima, maps_type& out_fms )
	{
		if( in_fms.empty( ) )
		{
			return false;
		}

		out_fms.resize( in_fms.size( ) );
		for( maps_type::size_type l = 0; l < in_fms.size( ); ++l )
		{
			if( !normalize_map_with_local_maxima( in_fms[ l ], step_local_maxima, out_fms[ l ] ) )
			{
				return false;
			}
		}

		return true;
	}

	// Conspicuity mapを作成（Intensity）
	inline bool conspicuity_map_for_intensity( const map_type& i_image, const size_t step_local_maxima, const double gauss_sigma, map_type& i_ncm )
	{
		if( i_image.empty( ) )
		{
			return false;
		}

		// Intensity feature maps
		maps_type i_fms;
		{
			// ガウシアンピラミッド
			pyramid_type i_pyr;
			if( !build_gaussian_pyramid( i_image, gauss_sigma, i_pyr ) )
			{
				return false;
			}

			// Center-Surround difference
			if( !across_scale_difference( i_pyr, i_pyr, i_fms ) )
			{
				return false;
			}
		}

		// Conspicuity map
		map_type i_cm;
		{
			pyramid_type i_nfms;
			if( !normalize_maps_with_local_maxima( i_fms, step_local_maxima, i_nfms ) || !across_scale_addition( i_nfms, i_cm ) )
			{
				return false;
			}
		}

		// 正規化
		return normalize_map_with_local_maxima( i_cm, step_local_maxima, i_ncm );
	}

	// Conspicuity mapを作成（Color）
	inline bool conspicuity_map_for_color( const map_type& r_image, const map_type& g_image, const map_type& b_image, const map_type& y_image, const size_t step_local_maxima, const double gauss_sigma, map_type& c_ncm )
	{
		if( r_image.empty( ) || g_image.empty( ) || b_image.empty( ) || y_image.empty( ) )
		{
			return false;
		}

		// Red-Green feature maps
		maps_type rg_fms;
		{
			// ガウシアンピラミッド
			pyramid_type rg_pyr;
			if( !build_gaussian_pyramid( r_image - g_image, gauss_sigma, rg_pyr ) )	// 高速化の余地あり（計算に使用する部分だけ画像を用意すれば良い）
			{
				return false;
			}
		
			// Center-Surround difference
			if( !across_scale_difference( rg_pyr, -rg_pyr, rg_fms ) )
			{
				return false;
			}
		}

		// Blue-Yellow feature maps
		maps_type by_fms;
		{
			// ガウシアンピラミッド
			pyramid_type by_pyr;
			if( !build_gaussian_pyramid( b_image - y_image, gauss_sigma, by_pyr ) )
			{
				return false;
			}
		
			// Center-Surround difference
			if( !across_scale_difference( by_pyr, -by_pyr, by_fms ) )
			{
				return false;
			}
		}

		// Conspicuity map
		map_type c_cm;
		{
			pyramid_type rg_nfms, by_nfms;
			if( !normalize_maps_with_local_maxima( rg_fms, step_local_maxima, rg_nfms )
				|| !normalize_maps_with_local_maxima( by_fms, step_local_maxima, by_nfms )
				|| !across_scale_addition( rg_nfms + by_nfms, c_cm ) )
			{
				return false;
			}
		}

		// 正規化
		return normalize_map_with_local_maxima( c_cm, step_local_maxima, c_ncm );
	}

	// Conspicuity mapを作成（Orientation）
	inline bool conspicuity_map_for_orientation( const map_type& i_image, const size_t step_local_maxima, const double gauss_sigma, map_type& o_ncm )
	{
		if( i_image.empty( ) )
		{
			return false;
		}

		// 各方向について
		const size_t orientations = sizeof( GABOR_KERNELS ) / sizeof( GABOR_KERNELS[ 0 ] );	// Orientationの種類数
		maps_type nneo_fms( orientations );
		for( maps_type::size_type t = 0; t < nneo_fms.size( ); ++t )
		{
			const int kernel_width = sizeof( GABOR_KERNELS[ t ] ) / sizeof( GABOR_KERNELS[ t ][ 0 ] );
			const int kernel_height = sizeof( GABOR_KERNELS[ t ][ 0 ] ) / sizeof( GABOR_KERNELS[ t ][ 0 ][ 0 ] );

			// 各方向成分のOrientation feature maps
			maps_type o_fms;
			{
				// ガウシアンピラミッド
				pyramid_type o_pyr( PYRAMID_SCALES );
				{
					pyramid_type i_pyr;
					if( !build_gaussian_pyramid( i_image, gauss_sigma, i_pyr ) )
					{
						return false;
					}

					kernel_type gabor_kernel( kernel_width, kernel_height );
					std::copy( &GABOR_KERNELS[ t ][ 0 ][ 0 ], &GABOR_KERNELS[ t ][ 0 ][ 0 ] + kernel_width * kernel_height, gabor_kernel.begin( ) );
					for( pyramid_type::size_type l = SCALE_C[ 0 ]; l < o_pyr.size( ); ++l )
					{
						const map_type& target_layer = i_pyr[ l ];
						o_pyr[ l ].resize( target_layer.width( ), target_layer.height( ) );
						// mist::linear_filterとほぼ同等の処理（だけど端の部分にノイズが発生するため不使用）
						for( int x = 0; x < static_cast< int >( target_layer.width( ) ); ++x )
						{
							for( int y = 0; y < static_cast< int >( target_layer.height( ) ); ++y )
							{
								for( int i = - kernel_width / 2; i <= kernel_width / 2; ++i )
								{
									for( int j = - kernel_height / 2; j <= kernel_height / 2; ++j )
									{
										if( 0 <= x + i && x + i < static_cast< int >( target_layer.width( ) ) && 0 <= y + j && y + j < static_cast< int >( target_layer.height( ) ) )
										{
											o_pyr[ l ]( x, y ) += target_layer( x + i, y + j ) * gabor_kernel( i + kernel_width / 2, j + kernel_height / 2 );
										}
									}
								}
							}
						}
					}
				}
		
				// Center-Surround difference
				if( !across_scale_difference( o_pyr, o_pyr, o_fms ) )
				{
					return false;
				}
			}

			// 方向成分毎に統合されたOrientation feature maps
			maps_type o_nfms;
			if( !normalize_maps_with_local_maxima( o_fms, step_local_maxima, o_nfms ) || !across_scale_addition( o_nfms, nneo_fms[ t ] ) )
			{
				return false;
			}
		}

		// Conspicuity map
		const map_type o_cm = std::accumulate( nneo_fms.begin( ), nneo_fms.end( ), map_type( nneo_fms[ 0 ].width( ), nneo_fms[ 0 ].height( ) ) );

		// 正規化
		return normalize_map_with_local_maxima( o_cm, step_local_maxima, o_ncm );
	}

	// 特徴抽出
	template< class T, class Allocator >
	inline bool create_original_feature_maps( const mist::array2< mist::rgb< T >, Allocator >& in, map_type& i_fm, map_type& r_fm, map_type& g_fm, map_type& b_fm, map_type& y_fm )
	{
		typedef mist::array2< mist::rgb< typename T >, Allocator >::size_type size_type;

		if( in.empty( ) )
		{
			return false;
		}

		const size_type w = in.width( );
		const size_type h = in.height( );
		const size_type size = in.size( );

		// Intensity
		i_fm.resize( w, h );
		for( size_type i = 0; i < size; ++i )
		{
			i_fm[ i ] = ( static_cast< value_type >( in[ i ].r ) + static_cast< value_type >( in[ i ].g ) + static_cast< value_type >( in[ i ].b ) ) / 3.0;
		}

		// Red, Green, Blue, Yellow
		r_fm.resize( w, h );
		g_fm.resize( w, h );
		b_fm.resize( w, h );
		y_fm.resize( w, h );
		const value_type max_i = *std::max_element( i_fm.begin( ), i_fm.end( ) );
		for( size_type k = 0; k < size; ++k )
		{
			const value_type i = i_fm[ k ];
			if( max_i > i * 10 )
			{
				r_fm[ k ] = g_fm[ k ] = b_fm[ k ] = y_fm[ k ] = 0;
			}
			else
			{
				const value_type r = in[ k ].r / i;
				const value_type g = in[ k ].g / i;
				const value_type b = in[ k ].b / i;
				r_fm[ k ] = std::max< value_type >( 0.0, r - ( g + b ) / 2.0 );
				g_fm[ k ] = std::max< value_type >( 0.0, g - ( r + b ) / 2.0 );
				b_fm[ k ] = std::max< value_type >( 0.0, b - ( r + g ) / 2.0 );
				y_fm[ k ] = std::max< value_type >( 0.0, ( r + g ) / 2.0 - std::abs( r - g ) / 2.0 - b );
			}
		}

		return true;
	}
} // 名前空間 __itti__ の終わり

namespace itti
{
	/// IttiらのSaliency map関連のアルゴリズム
	//! - 参考文献
	//!   - Laurent Itti, Christof Koch, and Ernst Niebur,
	//!     "A model of saliency-based visual attention for rapid scene analysis,"
	//!     IEEE Transactions on Pattern Analysis and Machine Intelligence, vol.20, no.11, Nov. 1998
	//! 
	/// @brief Saliency mapを計算
	//! 
	//! RGBカラー画像からIntensity maps（6種類），Color maps（12種類），Orientation maps（24種類）の特徴マップを作成・統合することでSaliency mapを計算する．
	//! 
	//! @param[in]  in                 … 入力画像（RGBカラー画像）
	//! @param[out] out                … 出力画像（Saliency map）
	//! @param[in]  step_local_maxima  … 極大値を考慮した正規化処理における極大値探索の範囲（デフォルト：3）
	//! @param[in]  gauss_sigma        … ガウシアンピラミッド作成時のガウシアンカーネルのサイズ（デフォルト：5）
	//! @param[in]  intensity_weight   … Intensity mapの重み（デフォルト：1.0）
	//! @param[in]  color_weight       … Color mapの重み（デフォルト：1.0）
	//! @param[in]  orientation_weight … Orientation mapの重み（デフォルト：1.0）
	//! 
	template< class T1, class Allocator1, class T2, class Allocator2 >
	bool saliency_map( const mist::array2< mist::rgb< T1 >, Allocator1 >& in, mist::array2< T2, Allocator2 >& out, const size_t step_local_maxima = 3, const double gauss_sigma = 5, const double intensity_weight = 1.0, const double color_weight = 1.0, const double orientation_weight = 1.0 )
	{
		if( in.empty( ) )
		{
			return false;
		}

		// 特徴抽出
		__itti__::map_type i_image, r_image, g_image, b_image, y_image;
		if( !__itti__::create_original_feature_maps( in, i_image, r_image, g_image, b_image, y_image ) )
		{
			return false;
		}

		// Conspicuity map
		__itti__::map_type i_cm, c_cm, o_cm;
		if( !__itti__::conspicuity_map_for_intensity( i_image, step_local_maxima, gauss_sigma, i_cm )
			|| !__itti__::conspicuity_map_for_color( r_image, g_image, b_image, y_image, step_local_maxima, gauss_sigma, c_cm )
			|| !__itti__::conspicuity_map_for_orientation( i_image, step_local_maxima, gauss_sigma, o_cm ) )
		{
			return false;
		}

		//__itti__::map_type temp;
		//__itti__::normalize( i_cm, temp, 0, 255 );
		//mist::write_bmp( temp, "i_cm.bmp" );
		//__itti__::normalize( c_cm, temp, 0, 255 );
		//mist::write_bmp( temp, "c_cm.bmp" );
		//__itti__::normalize( o_cm, temp, 0, 255 );
		//mist::write_bmp( temp, "o_cm.bmp" );

		// Saliency map
		return __itti__::normalize( intensity_weight * i_cm + color_weight * c_cm + orientation_weight * o_cm, out, 0.0, 255 );
	}

} // 名前空間 itti の終わり


// mist名前空間の終わり
_MIST_END


#endif // __INCLUDE_MIST_TIMER__
